---
title: "Provino"
author: "Denti"
date: "1/20/2021"
output: html_document
---

```{r}
Rcpp::sourceCpp("/home/fra/Documents/GitHub/CommonAtomModel/Functions/CAM/CAM.cpp")
source("/home/fra/Documents/GitHub/CommonAtomModel/Functions/CAM/CAM_ord.R")
```

# Data

6 distribution osservate, 4 gruppi

```{r}
u <- 30
x0 <- replicate(1, c(rnorm(u,3),rnorm( 3*u,10,.5)))
x1 <- replicate(1, c(rnorm(2*u,3),rnorm( 2*u,10,.5)))
x2 <- replicate(3, c(rnorm(2*u,-5),rnorm(2*u,10)))
x3 <- c(rnorm(2*u,3),rnorm( 2*u,10,.5),rnorm( 2*u,-5,.5),rnorm( 2*u,0,.5))

#yd <- round(c(x0,x1,x2,x3))
yd <- (c(x0,x1,x2,x3))
yg <- rep(1:6,c(rep(4*u,5),8*u))
plot(yd,col=yg)
```

# Run the model

```{r}
m1 <- CAM(y_obser = yd,
            y_group = yg,
            K0 = 20,
            L0 = 20,
            prior = list(
              # hyperparameters NIG
              m0= mean(yd), 
              k0=1/var(yd), 
              a0=3, b0=1,
              # hyperparameters alpha and beta
              a_alpha=3, b_alpha =3,
              a_beta =3, b_beta = 3),
            nsim = 5000,
            burn_in = 5000,
            thinning = 1,
            verbose = T,
            fixedAB = F,
            kappa=0.5,
            cheap=F,
            seed=123456,
           sigma.prop.beta = 1)

m2 <- CAM(y_obser = yd,
            y_group = yg,
            K0 = 20,
            L0 = 20,
            prior = list(
              # hyperparameters NIG
              m0= mean(yd), 
              k0=1/var(yd), 
              a0=3, b0=1,
              # hyperparameters alpha and beta
              a_alpha=3, b_alpha =3,
              a_beta =3, b_beta = 3),
            nsim = 5000,
            burn_in = 5000,
            thinning = 1,
            verbose = T,
            fixedAB = T,
            kappa=0.5,
            cheap=F,
            seed=123456,sigma.prop.beta = 1
  )
```


```{r}
par(mfrow=c(1,1))
r <- apply(m1$post.dens,c(1,2),mean)
matplot(r,type="l")

```


# Alpha e Beta

```{r}
plot(ts(m1$A_DP)) 
plot(ts(m2$A_DP)) 
acf(m1$A_DP)
pacf(m1$A_DP)
plot(ts(m1$B_DP))  
acf(m1$B_DP)
pacf(m1$B_DP)
```

# Clustering

```{r}
matplot(m1$NN.cz)
r1=PSM(m1$Z_j)
image(r1)
a1=mcclust.ext::minVI(r1,method = "greedy")
plot(yd,col=rep(a1$cl,table(yg)))
r=PSM(m2$Z_j)
image(r)
a=mcclust.ext::minVI(r)
plot(yd,col=a$cl)

r=PSM(m2$Csi_ij)
image(r)
a=mcclust.ext::minVI(r)
plot(yd,col=a$cl)
```

# Densities

```{r, fig.width=15,fig.height=12}
xx <- seq(-10,15,by = .1)
LLL <- list()

LLL <- posterior.densities(m1,howfarback = 1000,normalize = T,xx = seq(-10,15,by = .10))
par(mfrow=c(1,2))
for(hh in 1:6){
hist(yd[yg==hh],breaks = 30,freq=F, main="hist+mcmc+mean")
for(i in 1:1000)
lines(LLL[[hh]][i,]~xx,col=1)
lines(colMeans(LLL[[hh]])~xx,col=2,lwd=3)

hist(yd[yg==hh],breaks = 30,freq=F, main="hist+mean")
lines(colMeans(LLL[[hh]])~xx,col=2,lwd=3)
}


# sim <- 500
# ind <- 500
# ygind <- yg[[ind]]
# 
# plot(yd)
# points(yd[ind]~c(ind),col=2,pch=21,bg=2)
# 
# mat <- matrix(NA,nsim,2)
# for(sim in 2:nsim){
# 
# mat[sim,1] <- m1$OMEGA[[sim]][ m1$Csi_ij[[sim]][ind] 
#                  ,
#                   m1$Z_j[[sim]]  [ygind]]
# mat[sim,2] <- m1$THETA[[sim]][ m1$Csi_ij[[sim]][ind] 
#                  ,
#                  1]
# }
# 
# plot(ts(mat))




```

